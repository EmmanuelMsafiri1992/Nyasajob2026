name: Deploy to Production

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Deploy to server via SSH
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          port: ${{ secrets.SERVER_PORT }}
          script: |
            cd /home/indegnnk/Nyasajob2026repo
            git pull origin main

            DEPLOYPATH=/home/indegnnk/nyasajob.com

            # FIRST: Delete ALL cached config before anything else
            rm -f $DEPLOYPATH/bootstrap/cache/*.php
            rm -rf $DEPLOYPATH/storage/framework/cache/data

            /bin/rsync -av --delete \
              --exclude='.git' \
              --exclude='.env' \
              --exclude='.htaccess' \
              --exclude='public/.htaccess' \
              --exclude='vendor' \
              --exclude='storage/logs/*' \
              --exclude='storage/framework/cache/*' \
              --exclude='storage/framework/sessions/*' \
              --exclude='storage/framework/views/*' \
              --exclude='storage/app/public/*' \
              --exclude='public/storage' \
              --exclude='bootstrap/cache/*.php' \
              ./ $DEPLOYPATH/

            chmod 755 $DEPLOYPATH

            # Create required storage directories
            mkdir -p $DEPLOYPATH/storage/framework/cache/data
            mkdir -p $DEPLOYPATH/storage/framework/sessions
            mkdir -p $DEPLOYPATH/storage/framework/views
            mkdir -p $DEPLOYPATH/storage/logs
            mkdir -p $DEPLOYPATH/bootstrap/cache

            # Set permissions
            chmod -R 775 $DEPLOYPATH/storage $DEPLOYPATH/bootstrap/cache
            chown -R indegnnk:indegnnk $DEPLOYPATH

            cd $DEPLOYPATH

            # Put site in maintenance mode
            php artisan down --retry=60 2>/dev/null || true

            php artisan storage:link 2>/dev/null || true
            composer install --no-dev --optimize-autoloader --no-interaction
            php artisan migrate --force

            # Clear all caches AFTER composer (don't cache config - causes issues)
            php artisan optimize:clear 2>/dev/null || true
            php artisan view:cache

            # =============================================
            # RSS FEED PROCESSING PIPELINE
            # Ensures ALL countries have their jobs processed
            # =============================================

            # Clear city cache to allow new city creation for missing countries
            php artisan tinker --execute="
              \Illuminate\Support\Facades\Cache::forget('default_city_ZA');
              \Illuminate\Support\Facades\Cache::forget('default_city_NG');
              \Illuminate\Support\Facades\Cache::forget('default_city_KE');
              \Illuminate\Support\Facades\Cache::forget('default_city_GH');
              echo 'City caches cleared';
            " 2>/dev/null || true

            # Step 1: Process ALL approved staged items (fills city_id, cleaned_description)
            # This is REQUIRED before import - without this, jobs won't import
            php artisan rss:process --status=approved --all --limit=2000 2>/dev/null || true

            # Step 2: Process pending items too (in case some need review)
            php artisan rss:process --status=pending --all --limit=1000 2>/dev/null || true

            # Step 3: Fix company names extracted from titles
            php artisan rss:process --fix-companies --limit=2000 2>/dev/null || true

            # Step 4: Redistribute jobs to correct countries based on location
            php artisan rss:process --redistribute --limit=2000 2>/dev/null || true

            # Step 5: Re-process any items that still have NULL city_id (force city creation)
            php artisan tinker --execute="
              \$items = \App\Models\JobFeedStagedItem::whereNull('city_id')
                ->whereIn('status', ['approved', 'pending'])
                ->limit(500)
                ->get();
              \$cleaner = app(\App\Services\RssFeed\JobDataCleanerService::class);
              \$fixed = 0;
              foreach(\$items as \$item) {
                try {
                  \$cleaner->cleanStagedItem(\$item);
                  if(\$item->city_id) \$fixed++;
                } catch(\Exception \$e) {}
              }
              echo \"Fixed city_id for {\$fixed} items\";
            " 2>/dev/null || true

            # Step 6: Import ALL processed approved jobs to posts table
            # This makes them LIVE on frontend for ALL countries
            php artisan rss:import --limit=2000 --auto-approve 2>/dev/null || true

            # Step 7: Clean up posts without application details
            php artisan posts:cleanup-no-apply --limit=2000 2>/dev/null || true

            # Step 8: Verify imports worked (log count per country)
            php artisan tinker --execute="
              \$counts = \App\Models\Post::where('created_at', '>=', now()->subDay())
                ->selectRaw('country_code, COUNT(*) as cnt')
                ->groupBy('country_code')
                ->pluck('cnt', 'country_code')
                ->toArray();
              echo 'Jobs imported today by country: ' . json_encode(\$counts);
            " 2>/dev/null || true

            # Fix database auto-increment and disable broken feeds
            php artisan tinker --execute="
              DB::statement('ALTER TABLE job_feed_sources MODIFY id BIGINT UNSIGNED NOT NULL AUTO_INCREMENT');
              DB::statement('ALTER TABLE job_feed_logs MODIFY id BIGINT UNSIGNED NOT NULL AUTO_INCREMENT');
              DB::table('job_feed_sources')->where('name', 'LIKE', 'Indeed%')->update(['status' => 'paused']);
              DB::table('job_feed_sources')->whereIn('name', ['Working Nomads', 'Authentic Jobs', 'Remote.co'])->update(['status' => 'paused']);
              echo 'Database fixes applied';
            " 2>/dev/null || true

            # Seed comprehensive job feed sources (skips existing ones)
            php artisan jobs:seed-sources 2>/dev/null || true

            # Clear caches
            php artisan cache:forget countries_needing_jobs 2>/dev/null || true

            # NOTE: jobs:smart-fetch runs via scheduler 3x daily, not during deployment
            # (it takes too long for deployment as it fetches for all countries)

            # Bring site back up
            php artisan up

            echo "Deployment completed: $(date)"